<%= content_tag @component,
  id: @id,
  data: {
    'document-id': @document.id.to_s.parameterize,
    'document-counter': @counter
  },
  itemscope: true,
  itemtype: @document.itemtype,
  class: classes.flatten.join(' ') do %>

  <%= header %>

  <% if body.present? %>
    <%= body %>
  <% else %>
    <div class="document-main-section">

      <% if @component.to_s == 'div' %>
        <% breadcrumb_paths = helpers.collection_breadcrumb_paths(@document) %>
        <% if breadcrumb_paths.present? %>
          <nav class="collection-breadcrumbs mb-3" aria-label="<%= t('breadcrumbs.collections', default: 'Collections') %>">
            <% breadcrumb_paths.each do |path| %>
              <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/catalog"><%= t('labels.L_SEARCH_BREADCRUMB') %></a></li>
                <% path.each_with_index do |segment, idx| %>
                  <% active = (idx == path.length - 1) %>
                  <li class="breadcrumb-item <%= 'active' if active %>">
                    <%= link_to segment[:label],
                                helpers.collection_breadcrumb_url(segment[:value], segment[:field]),
                                aria: (active ? { current: 'page' } : {}) %>
                  </li>
                <% end %>
                <% if @document._source['is_issue']&.first == "Yes" && @document._source['serial_title'] %>
                  <li class="breadcrumb-item">
                    <a href="/catalog/<%= @document._source['serial_key'][0] %>"><%= @document._source['serial_title'][0] %></a>
                  </li> 
                <% end %>
              </ol>
            <% end %>
          </nav>
        <% end %>
      <% end %>


      <%= title %>
      <%= embed %>
      <%= content %>

      <% if @component == :div %>
        <div id="document-togglable-content" class="container-fluid">
          <div class="row flex-nowrap">
            <!-- Sidebar -->
            <div id="toggle-menu" class="col collapse collapse-horizontal show">
              <div class="document-sidebar-header">
                <h3><%= t('labels.L_SERIAL_RECORD') %></h3>
                <button id="toggle-doc-metadata1" class="btn btn-outline-custom" type="button" data-bs-toggle="collapse" data-bs-target="#toggle-menu" aria-expanded="true" aria-controls="toggle-menu">
                    <i class="bi bi-arrow-left"></i>
                </button>
              </div>
              <div>  
                <%= metadata %>
                <% metadata_sections.each do |section| %>
                  <%= section %>
                <% end %>

                <ul class="list-unstyled mb-0">
                  <li class="mb-1">
                    <a href="/catalog/<%= params[:id] %>/librarian_view" data-blacklight-modal="trigger" data-turbo="false">
                      <i class="bi bi-journal-text me-1" aria-hidden="true"></i>
                      <%= t('blacklight.tools.librarian_view') %>
                    </a>
                  </li>
                  <li>
                    <a href="/catalog/<%= params[:id] %>/citation" data-blacklight-modal="trigger" data-turbo="false">
                      <i class="bi bi-quote me-1" aria-hidden="true"></i>
                      <%= t('blacklight.tools.cite') %>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <!-- Main Content -->
            <div id="doc-main" class="col">

              <% if @document._source["is_serial"]&.first == "No" %>
              <div>
                  
                  <div class="mt-2 d-flex gap-2 flex-wrap" id="download-toolbar"
                       data-docid="<%= @document._source['id'] %>"
                       data-arkpath="<%= @document._source['ark'].to_s.gsub('https://n2t.net/ark:/','') %>">
                   
                      <button id="toggle-doc-metadata2" class="btn btn-outline-custom btn-sm d-inline-flex align-items-center gap-2 fs-6" type="button" data-bs-toggle="collapse" data-bs-target="#toggle-menu" aria-expanded="true" aria-controls="toggle-menu">
                          <i class="bi bi-layout-sidebar fs-5" aria-hidden="true"></i><span><%= t('labels.L_RECORD') %></span>
                      </button>
                    <a id="btn-download-img" class="btn btn-outline-custom btn-sm d-inline-flex align-items-center gap-2 fs-6 disabled" target="_blank" rel="noopener" aria-disabled="true">
                      <i class="bi bi-image fs-5" aria-hidden="true"></i>
                      <span class="visually-hidden"><%= t('blacklight.tools.download_image_aria', default: 'Download current image') %></span>
                      Download current image
                    </a>
                    <a id="btn-download-page" class="btn btn-outline-custom btn-sm d-inline-flex align-items-center gap-2 fs-6 disabled" target="_blank" rel="noopener" aria-disabled="true">
                      <i class="bi bi-file-earmark-arrow-down fs-5" aria-hidden="true"></i>
                      <span class="visually-hidden"><%= t('blacklight.tools.download_page_pdf_aria', default: 'Download current image as PDF') %></span>
                      Download current image as PDF
                    </a>
                    <a id="btn-download-full" class="btn btn-outline-custom btn-sm d-inline-flex align-items-center gap-2 fs-6 disabled" target="_blank" rel="noopener" aria-disabled="true">
                      <i class="bi bi-filetype-pdf fs-5" aria-hidden="true"></i>
                      <span class="visually-hidden"><%= t('blacklight.tools.download_full_pdf_aria', default: 'Download full searchable PDF') %></span>
                      Download full searchable PDF
                    </a>
                  </div>
                  <script>
                    (function(){
                      const bar = document.getElementById('download-toolbar');
                      if(!bar) return;

                      const docid = bar.dataset.docid;
                      const ark = bar.dataset.arkpath;

                      const full = document.getElementById('btn-download-full');
                      const page = document.getElementById('btn-download-page');
                      const pageImg = document.getElementById('btn-download-img');
                      const invalidLinks = new Set();

                      function disableLink(el) {
                        if (!el) return;
                        el.classList.add('disabled');
                        el.setAttribute('aria-disabled', 'true');
                        el.removeAttribute('href');
                      }

                      function enableLink(el, href) {
                        if (!el || !href) return;
                        el.href = href;
                        el.classList.remove('disabled');
                        el.removeAttribute('aria-disabled');
                      }

                      // Check if a link looks usable. We only mark as bad on explicit 404.
                      async function validateAndEnable(el, href, { strict = false } = {}) {
                        if (!el || !href) { disableLink(el); return; }
                        if (invalidLinks.has(href)) { disableLink(el); return; }

                        try {
                          const resp = await fetch(href, { method: 'HEAD' });
                          if (resp && resp.ok) {
                            enableLink(el, href);
                            return;
                          }
                          if (resp && resp.status === 404) {
                            invalidLinks.add(href);
                          }
                          if (strict) {
                            disableLink(el);
                            return;
                          }
                          // non-OK but not strict: do not enable, keep disabled
                          disableLink(el);
                        } catch (_) {
                          // Network/CORS error: only enable when not strict
                          if (!strict) {
                            enableLink(el, href);
                          } else {
                            disableLink(el);
                          }
                        }
                      }

                      // Update links based on current pageNum in the URL
                      function updateForCurrentPage(data){
                        if (!data) return;

                        // Full-document PDF (static once data is fetched)
                        if (full) {
                          if (data.docPdfUri) {
                            validateAndEnable(full, data.docPdfUri, { strict: true });
                          } else {
                            disableLink(full);
                          }
                        }

                        const params = new URLSearchParams(window.location.search);
                        let idx = 0;
                        if (params.has('pageNum')) {
                          const p = parseInt(params.get('pageNum'), 10);
                          if (!isNaN(p) && p > 0) idx = p - 1;
                        }

                        const listPdf = data.canvasDownloadPdfUris || [];
                        if (page) {
                          if (listPdf[idx]) {
                            validateAndEnable(page, listPdf[idx]);
                          } else {
                            disableLink(page);
                          }
                        }

                        const listImg = data.canvasDownloadImgUris || [];
                        if (pageImg) {
                          if (listImg[idx]) {
                            validateAndEnable(pageImg, listImg[idx]);
                          } else {
                            disableLink(pageImg);
                          }
                        }
                      }

                      // Fetch once, then update on URL changes
                      let dlData = null;
                      fetch(`/dl/${encodeURIComponent(docid)}/${ark}`)
                        .then(r => r.json())
                        .then(data => {
                          dlData = data;
                          updateForCurrentPage(dlData);
                        })
                        .catch(() => {});

                      // Listen for navigation events that may change the query string
                      function onLocationChange(){ updateForCurrentPage(dlData); }
                      window.addEventListener('popstate', onLocationChange);
                      window.addEventListener('hashchange', onLocationChange);

                      // Poll for pageNum changes (covers pushState/replaceState navigation in viewer)
                      let lastSearch = window.location.search;
                      setInterval(() => {
                        if (window.location.search !== lastSearch) {
                          lastSearch = window.location.search;
                          onLocationChange();
                        }
                      }, 750);
                    })();
                  </script>

              </div>


                <% if @document._source["ark"] %>
                  <div id="my-mirador" data-docid="<%= @document._source['ark'] %>"></div>
                  
                <% else %>
                  <img src="/assets/404.webp" class="not-found-icon"/>
                  <p>Sorry, there was a problem loading the images for this item.</p>
                <% end %>

                <%= render(::IiifComponent.new(document: @document, term: params[:q])) %>
              <% else %>
              <button id="toggle-doc-metadata3" class="btn btn-outline-custom" type="button" data-bs-toggle="collapse" data-bs-target="#toggle-menu" aria-expanded="true" aria-controls="toggle-menu">
                  <i class="bi bi-layout-sidebar"></i><span><%= t('labels.L_SERIAL_RECORD') %></span>
              </button>
                <%= render CollectionItemsComponent.new(
                  documentId: params[:id],
                  page: params[:page] || 1,
                  per_page: 12
                ) %>
              <% end %>
            </div>
          </div>
        </div>



      <% else %>
        <%= metadata %>
        <% metadata_sections.each do |section| %>
          <%= section %>
        <% end %>
        <%= thumbnail %>
        <%= render(::PageSearchComponent.new(docId: @document._source["id"] , arkUrl: @document._source["ark"], term: params[:q])) %>
      <% end %>

      <br/>
      <% partials.each do |partial| %>
        <%= partial %>
      <% end %>
    </div>
  <% end %>

  <%= footer %>
<% end %>
